!function(d,_,e,h){var l,i,u=d.isEmbedded||!1;l=!!(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i));var o=null,m=null,n=null,f=null,s={};function y(e,t){"agents"==e&&d.bot&&(t[bot._id]||(t[bot._id]=bot));try{localStorage.setItem(h+"."+e,JSON.stringify(t))}catch(i){}s[h+"."+e]=t}function r(e){if(s[h+"."+e])return s[h+"."+e];var t=null;try{t=localStorage.getItem(h+"."+e)}catch(i){}if(t){if("iticksId"==e)try{return s[h+"."+e]=JSON.parse(t)}catch(i){return s[h+"."+e]=t}return"agents"==e&&d.bot&&(t[bot._id]||(t[bot._id]=bot)),s[h+"."+e]=JSON.parse(t)}return"agents"==e?((t={})[bot._id]=bot,s[h+"."+e]=t):null}function c(){try{localStorage.setItem(h+"_iticks.subs",Date.now()+"")}catch(e){}}function a(e){e||(e="");var t,i,s=0;for(0===e.length&&(s=0),t=0,i=e.length;t<i;t++)s=(s<<5)-s+e.charCodeAt(t),s|=0;switch(Math.abs(s)%7){case 0:return"#EF6C00";case 1:return"#00897B";case 2:return"#5C6BC0";case 3:return"#EC407A";case 4:return"#BF360C";case 5:return"#8D6E63";case 6:return"#689F38"}return"#7B1FA2"}var p=[],t=!1;function g(){if(!t&&socket&&h&&0<p.length){var e=p.splice(0);company.company_settings.disable_user_event||socket.emit("user-event.addBulk",e,De,Oe,h)}}function k(e,t,i){if("NAME"==e.type){if(function s(e){return!(100<e.length)}(t))return t}else{if("TEXT"==e.type)return t;if("EMAIL"==e.type){if(function a(e){return/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(String(e).toLowerCase())}(t))return t}else{if("PHONE"==e.type)return function n(e,t){return t?t.isValidNumber()?t.getNumber():"+"==(e=e.replace(/[^0-9+]/gi,"")).substr(0,1)&&(!(!d.intlTelInputUtils||!intlTelInputUtils.isValidNumber(e))&&e):e}(t,i?i.data("intl"):null);if("REGEX"==e.type){if(null==e.regex_pattern||""==e.regex_pattern)return t;if(new RegExp(e.regex_pattern).test(t))return t}}}return!1}function v(e,t){e=Autolinker.link(e,{email:!1,phone:!1,stripPrefix:!1,truncate:30}),t&&(e=filterXSS(e,{css:!1}));var i=_("<div/>").html(e);return _("a",i).attr("target","_blank"),i.html()}function E(e){return function i(e){var t=e.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);if(t&&11==t[2].length)return"https://www.youtube.com/embed/"+t[2];return null}(e)||function s(e){var t=e.match(/^.*(vimeo\.com\/)((channels\/[A-z]+\/)|(groups\/[A-z]+\/videos\/))?([0-9]+)/);if(t)return"https://player.vimeo.com/video/"+t[5];return null}(e)||e}var T=Math.floor(1e8*Math.random()),x=null,b="Show",I={_val:null,_pageVisible:!1,_listeners:[],onChange:function(e){I._listeners.push(e)},getValue:function(){return I._val},setValue:function(e){if(e!=I._val){var t=I._val;I._val=e;for(var i=0;i<I._listeners.length;i++)I._listeners[i].call(null,e,t)}}},w=!1,C=!1,N=null;function A(e,t){var i=_(".iticks-message-payment").closest(".init-msgs").length<1,s=se.getLastPaymentMsg();s&&s.fields.payload.node_id==t.msgId?Se.method("message.updateFieldVal",[h,s.id,De,Oe,"State",{state:e,orderId:t.orderId},i?null:R(),D,landing]):Se.method("message.updateFieldVal",[h,t.msgId,De,Oe,"State",{state:e,orderId:t.orderId},i?null:R(),D,landing])}d.addEventListener("message",function ze(e){var t;if(e.data&&"history"==e.data.type){for(t=0;t<e.data.data.length;t++)e.data.data[t].tab_id=T,x=e.data.data[t].url,null==N&&(N=x),-1<["Show","Hide"].indexOf(e.data.data[t].type)&&("Hide"==b&&"Show"==e.data.data[t].type&&"WIDGET_MAXIMIZED"==I.getValue()&&$("READ"),"Hide"===(b=e.data.data[t].type)?!company.company_settings.disable_user_event&&De&&Me&&Se.method("session.activeStatus",[h,De,navigator.userAgent,ref,!0]):!company.company_settings.disable_user_event&&De&&Me&&Se.method("session.activeStatus",[h,De,navigator.userAgent,ref,!1]));p.push.apply(p,e.data.data),g(),Me&&C&&!w&&N!=x&&(w=!0,N=x,Se.method("session.getUpdatedTrigger",[h,x,De,Oe],function(e,t){if(w=!1,C){!function a(){o&&clearTimeout(o);m&&clearTimeout(m)}(),Te(),se.removeTriggerFromUI();var i=1e3*(company.company_settings.engage_wait_time||0);if(n){var s=Date.now()-n;i=s<i?i-s:0}"VARIATON_TRIGGERS"==t.type?se.addTriggers(t,i):se.addMultiMsgTrigger(t,0,null,i)}}))}else if(e.data&&"function"==e.data.type)!e.data.data||"event"!=e.data.data.type&&"playbook"!=e.data.data.type||(_(".init-msgs").remove(),ie=[],_(".quick-replies").empty().removeData()),Se.method("user-functions.call",[e.data.data,De,Oe,h,x]),Ge||(Se.sub("messages.forclient.v2",[De,h,0],function(){}),c());else if(e.data&&"visibility"==e.data.type)I.setValue(e.data.data);else if(e.data&&"sethubtk"==e.data.type){if(Le&&Le.ext_ids&&Le.ext_ids.hubId)return;Se.method("chat-user.sethubtk",[h,De,Oe,e.data.data])}else if(e.data&&"setls"==e.data.type){if(Le&&Le.ext_ids&&Le.ext_ids.lsCId)return;Se.method("chat-user.setleadsquared",[h,De,Oe,e.data.data])}else if(e.data&&"setga"==e.data.type){if(Le&&Le.ext_ids&&Le.ext_ids.gaId)return;Se.method("chat-user.setga",[h,De,Oe,e.data.data])}else if(e.data&&"setInitData"==e.data.type)i=e.data.data;else if(e.data&&"paymentAuthorized"==e.data.type){A("SUCCESS",{msgId:e.data.msgId,orderId:e.data.data})}else if(e.data&&"paymentDismiss"==e.data.type){A("FAILURE",{msgId:e.data.msgId,orderId:null})}else if(e.data&&"paymentInitiate"==e.data.type){A("INITIATE",{msgId:e.data.msgId,orderId:null})}else if(e.data&&"webview.frame.ready"==e.data.type)se.getLastWebviewMsg()&&(document.getElementById("webviewiframe").contentWindow.postMessage({msgId:se.getLastWebviewMsg().id,body:se.getLastWebviewMsg().fields.payload.body},"*"),_(".iframe-loading").addClass("hidden"),_(".iticks-webview-iframe").removeClass("hidden"),_("#webviewiframe").show());else if(e.data&&"webview"==e.data.type){e.data.msgId==se.getLastWebviewMsg().id&&(J(e.data.text,"Webview",e.data.jsonData),Ne(),_(".iticks-chat-send-button").removeClass("txtBoxHidden"),_(".iframe-loading").addClass("hidden"),_(".iticks-webview-iframe").addClass("hidden"),_(".iticks-webview-block").addClass("hidden"))}},!1);var S=null;var M=null,D=null;function R(){var e=null,t=_(".init-msgs").eq(-1);if(0<t.length){var i=(e=t.data()).triggers,s=e.trigger;if((e={messages:[],actions:[]}).inputState=i.inputState,e.inputPlaceholder=i.inputPlaceholder,"VARIATON_TRIGGERS"==i.type)e.messages.push(s),e.actions.push.apply(e.actions,s.payload.actions),e.node_id=s.payload.node_id;else for(var a=0;a<i.nodes.length;a++)e.messages.push(i.nodes[a]),e.actions.push.apply(e.actions,i.nodes[a].payload.actions),e.node_id=i.nodes[a].payload.node_id}return e}var L,O,G,U,B,P,F,Y,V,H,q,X,W,z,Q,K,j,J=(O=!(L=[]),G=1,function(s,a,e,t){if(t=t||"USER_TEXT",(s=s?s.trim():null)||"USER_ACTION"==t){var i="INPUT";if("DropdownValue"==a?i="TRIGGER_QUESTION":"Datepicker"==a?i="FORM":"Webview"==a?i="WEB_VIEW":"SliderValue"==a?i="SLIDER":"MenuValue"==a?i="MENU":"MultiSelectionValues"==a?i="MULTI_SELECTION":_(".qrnode").each(function(){var e=_(this);if(s.toLowerCase().trim()==e.text().toLowerCase().trim())return i="TRIGGER_QUESTION",s=e.text(),!1}),O)L.push([s]);else{var n={text:s,_type:t,node_id:Date.now()+""};"USER_ACTION"==t&&(delete n.text,e.isSkipped&&(n.skip=!0)),Ie({collection:"messages",msg:"added",id:n.node_id,fields:{isBotMsg:!1,msg_time:Date.now(),msg_type:n._type,sender_id:"4TacrSuTKNvu4Fphd_cu",view_state:"SENDING",payload:n}},"added"),u||parent.postMessage({type:"reset.closebtn"},"*"),"WEB_VIEW"!=i&&"SLIDER"!=i||(n.jsonData=e),O=!0,Se.method("message.add.client",[h,De,D,Oe,n._type,n,i,R(),landing],function(e,t){if(O=!1,e){if(console.log("error sending msg",e),10<G)return;setTimeout(function(){J(s,a,t)},500*Math.max(G++,10))}else if(M&&M.fields.isWithBot&&se.renderTypingTemplate(),o&&clearTimeout(o),m&&clearTimeout(m),0<L.length){var i=L.shift();J(i[0],a,t)}}),Ge||(Se.sub("messages.forclient.v2",[De,h,0],function(){}),c())}}}),Z=null,$=function(e,t){Z&&"USER_TEXT"!=Z.fields.msg_type&&"USER_ACTION"!=Z.fields.msg_type&&"USER_FILE"!=Z.fields.msg_type&&["SENT","DELIVERED","READ"].indexOf(e)>["SENT","DELIVERED","READ"].indexOf(Z.fields.view_state)&&(Se.method("message.change.view_state",[Z.fields.company,Z.fields.device,Z.fields.conv_id,Z.id,e,Oe,Z.fields.payload],function(){t&&t()}),"READ"==e&&(Z=null))},ee=function(e,t){Ue[t]?Ue[t].photo?e.find(".iticks-operator-avatar-image").attr("src",Ue[t].photo).css("display","block"):Ue[t].name?e.find(".iticks-operator-avatar-txt").css("background",a(t)).text(Ue[t].name.substr(0,1).toUpperCase()).css("display","block"):e.find(".iticks-operator-avatar").hide():e.find(".iticks-operator-avatar").hide()},te=(U=null,function(){(U=U||_(".iticks-conversation-container").get(0))&&(U.scrollTop=U.scrollHeight-U.clientHeight+100)}),ie=[],se=(H=function(e){var t=_(".user-rating").removeClass("hidden").empty().removeData();t.data("msg",e),_('<div class="user-emotion" rating="1"><img src="/assets/rating/hate.svg"><span>Hate</span></div><div class="user-emotion" rating="2"><img src="/assets/rating/dislike.svg"><span>Dislike</span></div><div class="user-emotion" rating="3"><img src="/assets/rating/neutral.svg"><span>Neutral</span></div><div class="user-emotion" rating="4"><img src="/assets/rating/like.svg"><span>Like</span></div><div class="user-emotion" rating="5"><img src="/assets/rating/love.svg"><span>Love</span></div>').appendTo(t),"ENABLED"==lastState?(xe("HIDDEN",null,!0),lastState="ENABLED"):xe("HIDDEN",null,!0),_(".user-emotion",t).click(function(){_(".user-emotion").removeClass("selected-rating"),_(this).addClass("selected-rating"),"HIDDEN"==lastState?(xe("ENABLED","Add Comment",!0),lastState="HIDDEN"):xe("ENABLED","Add Comment",!0),be(!1),_(".iticks-send-submit-text").addClass("show"),_(".iticks-chat-send-button").addClass("active"),_(".iticks-chat-input").focus()})},q=[],W=0,z=!(X={}),j=K=Q=V=Y=F=P=B=null,{addMessage:function(e){if(se.removeTrigger(),e.fields.isBotMsg){if(Q&&(i=Q.data("trigger"))&&i.payload.msg_type==e.fields.payload.msg_type&&i.payload.text==e.fields.payload.text&&i.payload.img==e.fields.payload.img)return q.push({msg:e,template:ie[t]}),X[e.id]=1,Q.removeClass("init-msgs"),void(Q=null);for(var t=0;t<ie.length;t++){var i;if((i=ie[t].data("trigger"))&&i.payload.msg_type==e.fields.payload.msg_type&&i.payload.text==e.fields.payload.text&&i.payload.img==e.fields.payload.img)return"AGENT_QUESTION_FORM"==e.fields.msg_type?(ie[t].data(e),le({template:ie[t],msg:e})):"USER_PAYMENT"==e.fields.msg_type?(ie[t].data(e),oe(ie[t],e,e.id),parent.postMessage({type:"config.paymentOptions",options:e.fields.payload.options,msgId:e.id},"*")):"AGENT_RATING"==e.fields.msg_type?(ie[t].data(e),re(ie[t],e)):"AGENT_MULTI_SELECTION"==e.fields.msg_type&&(ie[t].data(e),de(ie[t],e)),q.push({msg:e,template:ie[t]}),X[e.id]=1,void ie.splice(t,1)[0].removeClass("init-msgs")}}var s=null,a=null;if(!X[e.id]){0<q.length&&(a=q[q.length-1]),se.removeUnfilledForm();var n=_(".user-rating").data().msg;n&&!n.fields.payload.rating&&Se.method("message.updateFieldVal",[h,n.id,De,Oe,"Rating",{rating:-1,comment:null},null,D,landing]);var l,d=null;if("USER_SYSTEM_TEXT"==e.fields.msg_type)"SENT"==e.fields.view_state&&"CLOSE_CHAT_WINDOW"==e.fields.payload.text?u||parent.postMessage({type:"minimize.chat"},"*"):"SENT"==e.fields.view_state&&"REDIRECT"==e.fields.payload.text&&(l=e.fields.payload.meta_data.url,d=function(){top.location.href=l});else if("CLIENT_JAVASCRIPT"==e.fields.msg_type){if(e.fields.payload.text&&!e.fields.payload.isExecuted){var o=Math.floor(10*Math.random()+1);setTimeout(function(){localStorage.getItem("executed.MsgId")!=e.id&&(parent.postMessage({type:"execute.javaScript",code:e.fields.payload.text,msgId:e.id},"*"),localStorage.setItem("executed.MsgId",e.id),Se.method("message.updateFieldVal",[h,e.id,De,Oe,"Client.JavaScript",!0,null,D,landing]))},o)}}else if("AGENT_TRIGGER_QUESTION"==e.fields.msg_type)s=ce(e),a&&a.msg.fields.msg_type,s.appendTo(".iticks-message-block-container"),q.push({msg:e,template:s});else if("AGENT_MULTI_SELECTION"==e.fields.msg_type)(s=pe(e)).appendTo(".iticks-message-block-container"),q.push({msg:e,template:s}),_(".quick-replies").empty().removeData();else if("AGENT_FORM"==e.fields.msg_type||"AGENT_QUESTION_FORM"==e.fields.msg_type)(s=ne(e)).appendTo(".iticks-message-block-container"),s.find(".form-field.unfilled .form-field-input").focus(),q.push({msg:e,template:s}),_(".quick-replies").empty().removeData();else if(-1<["USER_TEXT","USER_FILE","USER_ACTION"].indexOf(e.fields.msg_type)){for(var r=0;r<q.length;r++)if(-1<["USER_TEXT","USER_FILE","USER_ACTION"].indexOf(q[r].msg.fields.msg_type)&&q[r].msg.fields.payload.node_id==e.fields.payload.node_id){q[r].template.find(".iticks-time").text(moment(e.fields.msg_time).calendar(null,{sameElse:"DD/MM/YYYY hh:mm:ssA"})),q[r].msg.id=e.id;var c=q.splice(r,1);return q.push(c[0]),void(X[e.id]=1)}a&&-1<["USER_TEXT","USER_FILE","USER_ACTION"].indexOf(a.msg.fields.msg_type)?(function(e,t){var i="";i="SENDING"==e.fields.view_state?"Sending...":moment(e.fields.msg_time).calendar(null,{sameElse:"DD/MM/YYYY hh:mm:ssA"});var s=null;if("USER_FILE"==e.fields.msg_type){var a='<svg class="it-upload-icon" focusable="false" aria-hidden="true" viewBox="0 0 16 18"><path d="M14.154 6.918l-.004.003.001-.004-3.287 3.286-.006-.005-3.574 3.574c-.016.017-.03.036-.048.053l-.05.047-.043.041v-.002c-1.167 1.07-2.692 1.331-3.823.2-1.13-1.13-.89-2.677.18-3.843l-.005-.004.074-.073.016-.018c.006-.005.012-.009.017-.016l6.053-6.053.761.76-6.053 6.054-.029.028v.001l-.005.004-.073.074c.011-.01.025-.018.035-.03-.688.75-.93 1.636-.21 2.356.72.72 1.583.456 2.333-.232l-.03.034.04-.042.01-.008.008-.009.033-.03.031-.034.01-.009.007-.009 5.004-5.003.005.006 1.858-1.859c1.223-1.218 1.51-2.913.291-4.132C12.462.806 10.414.74 9.195 1.958L2.248 8.905c.003 0 .006-.002.008-.004-1.625 1.667-1.542 4.43.103 6.074 1.646 1.646 4.474 1.795 6.141.17-.003.002-.004.008-.008.012l.047-.047 6.053-6.054.042-.042.743.78-.025.021.001.002-6.05 6.05-.002.002-.002.001-.046.046h-.002c-2.094 2.04-5.578 1.894-7.652-.18-2.049-2.049-2.15-5.407-.183-7.505l-.006-.005h-.002l.076-.078 6.943-6.944.003-.002.004-.005c1.641-1.64 4.367-1.574 6.008.066 1.64 1.642 1.353 4.014-.288 5.655z" fill-rule="evenodd"></path></svg>'+v(e.fields.payload.name,!0);"UPLOADING"==e.fields.payload.status?a+=" Uploading...":"FAILED"==e.fields.payload.status&&(a+=" Not Uploaded."),s=_('<div class="iticks-message"/>').append(_('<p class="iticks-message-text"/>').html(a))}else s="USER_ACTION"==e.fields.msg_type?e.fields.payload&&e.fields.payload.skip?_('<div class="iticks-message"/>').append(_('<p class="iticks-message-text"/>').html(v("SKIP",!0))):_('<div class="iticks-message"/>').append(_('<p class="iticks-message-text"/>').html(v("",!0))):_('<div class="iticks-message"/>').append(_('<p class="iticks-message-text"/>').html(v(e.fields.payload.text,!0)));t.find(".iticks-message-group").append(s),t.find(".iticks-time").text(i),Ne(),s.find(".iticks-message-text").data("msg",e)}(e,a.template),q.push({msg:e,template:a.template})):(s=ye(e))&&(s.appendTo(".iticks-message-block-container"),q.push({msg:e,template:s})),_(".quick-replies").empty().removeData()}else if("AGENT_FORM_DATEPICKER"==e.fields.msg_type)(s=ge(e)).appendTo(".iticks-message-block-container"),q.push({msg:e,template:s}),_(".quick-replies").empty().removeData();else if("AGENT_TEXT"==e.fields.msg_type||"AGENT_RECO"==e.fields.msg_type||"AGENT_RATING"==e.fields.msg_type||"USER_PAYMENT"==e.fields.msg_type||"AGENT_YOUTUBE"==e.fields.msg_type)!a||"AGENT_TEXT"!=a.msg.fields.msg_type&&"AGENT_RECO"!=a.msg.fields.msg_type||a.msg.fields.sender_id!=e.fields.sender_id?((s=me(e)).appendTo(".iticks-message-block-container"),q.push({msg:e,template:s})):(ve(e,a.template),q.push({msg:e,template:a.template})),"USER_PAYMENT"==e.fields.msg_type&&parent.postMessage({type:"config.paymentOptions",options:e.fields.payload.options,msgId:e.id},"*"),_(".quick-replies").empty().removeData(),Ue[e.fields.sender_id]&&Ye(Ue[e.fields.sender_id]);else if("AGENT_WEBVIEW"==e.fields.msg_type)!a||"AGENT_TEXT"!=a.msg.fields.msg_type&&"AGENT_RECO"!=a.msg.fields.msg_type||a.msg.fields.sender_id!=e.fields.sender_id?((s=me(e)).appendTo(".iticks-message-block-container"),q.push({msg:e,template:s})):(ve(e,a.template),q.push({msg:e,template:a.template})),fe(e);else if("AGENT_SLIDER"==e.fields.msg_type)!a||"AGENT_TEXT"!=a.msg.fields.msg_type&&"AGENT_RECO"!=a.msg.fields.msg_type||a.msg.fields.sender_id!=e.fields.sender_id?((s=me(e)).appendTo(".iticks-message-block-container"),q.push({msg:e,template:s})):(ve(e,a.template),q.push({msg:e,template:a.template})),ue(e);else{if("SYSTEM_TEXT"!=e.fields.msg_type)return;(s=_e(e))&&(s.appendTo(".iticks-message-block-container"),q.push({msg:e,template:s}))}X[e.id]=1,te();var p="";if("USER_TEXT"!=e.fields.msg_type&&"USER_FILE"!=e.fields.msg_type&&"USER_ACTION"!=e.fields.msg_type){if("READ"==e.fields.view_state)Z=null,W=0;else if("AGENT_TRIGGER_QUESTION"==(Z=e).fields.msg_type)z||W++,p=e.fields.payload.text;else if(W++,p=e.fields.payload.text,"AGENT_QUESTION_FORM"==e.fields.msg_type||"AGENT_FORM"==e.fields.msg_type)for(var m=0;m<e.fields.payload.fields.length;m++){var f=e.fields.payload.fields[m];if(!f.value){p+="<br>"+f.name;break}}var g="Show"==b&&"WIDGET_MAXIMIZED"==I.getValue()?"READ":"DELIVERED";$(g,d)}else $("READ",d),Z=null,W=0;z="AGENT_TRIGGER_QUESTION"==e.fields.msg_type,0<W&&"WIDGET_MAXIMIZED"!=I.getValue()?-1<["USER_SYSTEM_TEXT","CLIENT_JAVASCRIPT","USER_FILE","SYSTEM_TEXT"].indexOf(e.fields.msg_type)||u||parent.postMessage({type:"notif",count:W,lastIsBot:!1,message:v(p)},"*"):u||parent.postMessage({type:"notif",count:0,message:""},"*"),y("lstmsgtime",e.fields.msg_time),clearTimeout(j),"READ"!==e.fields.view_state&&Fe()&&(j=setTimeout(function(){u||parent.postMessage({type:"show.chatwidget"},"*"),Pe=!0},500))}},updateMessage:function(t){var i=q.find(function(e){return e.msg.id==t.id});if(i){var s=!1;Object.keys(t.fields).forEach(function(e){i.msg.fields[e]=t.fields[e],"view_state"!=e&&(s=!0)}),!s||"AGENT_FORM"!=i.msg.fields.msg_type&&"AGENT_QUESTION_FORM"!=i.msg.fields.msg_type?"USER_PAYMENT"==i.msg.fields.msg_type?oe(i.template,i.msg,t.id):"AGENT_RATING"==i.msg.fields.msg_type&&t.fields.payload?re(i.template,t):"USER_FILE"==i.msg.fields.msg_type&&t.fields.payload?function(e,t){var i,s=_(".iticks-message-text",e);if(t&&t.fields.payload.name){var a=v(t.fields.payload.name,!0),n='<svg class="it-upload-icon" focusable="false" aria-hidden="true" viewBox="0 0 16 18"><path d="M14.154 6.918l-.004.003.001-.004-3.287 3.286-.006-.005-3.574 3.574c-.016.017-.03.036-.048.053l-.05.047-.043.041v-.002c-1.167 1.07-2.692 1.331-3.823.2-1.13-1.13-.89-2.677.18-3.843l-.005-.004.074-.073.016-.018c.006-.005.012-.009.017-.016l6.053-6.053.761.76-6.053 6.054-.029.028v.001l-.005.004-.073.074c.011-.01.025-.018.035-.03-.688.75-.93 1.636-.21 2.356.72.72 1.583.456 2.333-.232l-.03.034.04-.042.01-.008.008-.009.033-.03.031-.034.01-.009.007-.009 5.004-5.003.005.006 1.858-1.859c1.223-1.218 1.51-2.913.291-4.132C12.462.806 10.414.74 9.195 1.958L2.248 8.905c.003 0 .006-.002.008-.004-1.625 1.667-1.542 4.43.103 6.074 1.646 1.646 4.474 1.795 6.141.17-.003.002-.004.008-.008.012l.047-.047 6.053-6.054.042-.042.743.78-.025.021.001.002-6.05 6.05-.002.002-.002.001-.046.046h-.002c-2.094 2.04-5.578 1.894-7.652-.18-2.049-2.049-2.15-5.407-.183-7.505l-.006-.005h-.002l.076-.078 6.943-6.944.003-.002.004-.005c1.641-1.64 4.367-1.574 6.008.066 1.64 1.642 1.353 4.014-.288 5.655z" fill-rule="evenodd"></path></svg>';i="SUCCESS"==t.fields.payload.status?n+a:t&&"FAILED"==t.fields.payload.status?n+a+" Not Uploaded.":n+a+" Uploading..."}for(var l=0;l<s.length;l++){var d=_(s[l]).data().msg;if(d&&d.id==t.id)return _(s[l]).html(i).data("msg",t)}}(i.template,t):"AGENT_MULTI_SELECTION"==i.msg.fields.msg_type&&t.fields.payload&&de(i.template,t):le(i)}},resetUnread:function(){W=0,u||parent.postMessage({type:"notif",count:0,message:""},"*"),$("READ")},addMultiMsgTrigger:function(d,o,r,e){Ye(bot),C=!0,0==(o=o||0)&&(ie=[]);var c=_(".typing-container");if(d.nodes.length>o){var p=d.nodes[o],t=["AGENT_TRIGGER_QUESTION","AGENT_MULTI_SELECTION","AGENT_FORM","AGENT_QUESTION_FORM","AGENT_TEXT","AGENT_FORM_DATEPICKER","DATEPICKER","USER_PAYMENT","AGENT_RATING","AGENT_WEBVIEW","AGENT_SLIDER","AGENT_YOUTUBE"].indexOf(p.payload.msg_type);if(-1==t||t==undefined)return void se.addMultiMsgTrigger(d,o+1,r);var i=2e3;0==o&&(i=0),e?_(".iticks-footer-form-container").removeClass("hidden"):c.removeClass("iticks-hidden"),isLandingPage||0!=o||(i=e,n||(n=Date.now())),m=setTimeout(function(){f&&clearTimeout(f),c.removeClass("iticks-hidden"),"WIDGET_MAXIMIZED"!=I.getValue()&&(u||parent.postMessage({type:"minimize.chat"},"*")),_(".quick-replies").empty().removeData(),p.sender_id=bot._id,p.msg_time=Date.now();var e=null,t=r,i=p.payload.text||"";if("AGENT_TRIGGER_QUESTION"==p.payload.msg_type)e=ce({fields:p,id:p.id}),t=null;else if("AGENT_MULTI_SELECTION"==p.payload.msg_type)e=pe({fields:p,id:p.id}),t=null;else if("AGENT_FORM"==p.payload.msg_type||"AGENT_QUESTION_FORM"==p.payload.msg_type){e=ne({fields:p,id:p.id},(d.inputState,d.inputPlaceholder)),t=null;for(var s=0;s<p.payload.fields.length;s++){var a=p.payload.fields[s];i?i+="<br>"+a.name:i=a.name;break}}else if("AGENT_TEXT"==p.payload.msg_type||"AGENT_RATING"==p.payload.msg_type||"AGENT_YOUTUBE"==p.payload.msg_type)t?ie.push(ve({fields:p,id:p.id},t).addClass("init-msgs").data({trigger:p,triggers:d})):t=e=me({fields:p,id:p.id});else if("AGENT_FORM_DATEPICKER"==p.payload.msg_type)e=ge({fields:p,id:p.id}),t=null;else if("USER_PAYMENT"==p.payload.msg_type)e=me({fields:p,id:p.id}),parent.postMessage({type:"config.paymentOptions",options:p.payload.options,msgId:p.id},"*"),ie.push(e),t=null;else if("AGENT_WEBVIEW"==p.payload.msg_type)e=me({fields:p,id:p.id}),ie.push(e),fe({fields:p,id:p.id}),t=null;else{if("AGENT_SLIDER"!=p.payload.msg_type)return void se.addMultiMsgTrigger(d,o+1,t);t?ie.push(ve({fields:p,id:p.id},t).addClass("init-msgs").data({trigger:p,triggers:d})):e=me({fields:p,id:p.id}),ue({fields:p,id:p.id}),t=null}if(e){e.addClass("init-msgs").data({trigger:p,triggers:d}).appendTo(".iticks-message-block-container");var n=e.find(".form-field.unfilled .form-field-input");0<n.length&&n.focus(),ie.push(e)}u||parent.postMessage({type:"notif",count:1,lastIsBot:!0,message:v(i)},"*"),Fe()&&(u||parent.postMessage({type:"show.chatwidget"},"*"),Pe=!0),te();var l=se.getLastPaymentMsg();l&&"INITIATE"==l.fields.payload.state&&Se.method("message.updateFieldVal",[h,l.id,De,Oe,"State",{state:"FAILURE",orderId:null,isBlockNext:!0},null,D,landing]),se.addMultiMsgTrigger(d,o+1,t)},i)}else if(c.addClass("iticks-hidden"),d.nodes&&0<d.nodes.length){var s=d.nodes[d.nodes.length-1];_(".iticks-footer-form-container").removeClass("hidden"),!s||"USER_PAYMENT"!=s.payload.msg_type&&"AGENT_RATING"!=s.payload.msg_type&&"AGENT_SLIDER"!=s.payload.msg_type?xe(d.inputState,d.inputPlaceholder):"ENABLED"==d.inputState?(xe("HIDDEN",null,!0),lastState="ENABLED"):xe("HIDDEN",null,!0)}},addTriggers:function(i,e){Ye(bot),se.removeTrigger(),se.removeUnfilledForm(),C=!0;var s=0;0<e&&_(".iticks-footer-form-container").removeClass("hidden"),n||(n=Date.now()),o=setTimeout(function(){"WIDGET_MAXIMIZED"!=I.getValue()&&(u||parent.postMessage({type:"minimize.chat"},"*"));var e=i.nodes[s++%i.nodes.length];e.sender_id=bot._id,e.msg_time=Date.now(),(Q=ce({fields:e,id:"1"})).addClass("init-msgs").data({trigger:e,triggers:i}).appendTo(".iticks-message-block-container"),u||parent.postMessage({type:"notif",count:1,lastIsBot:!0,message:v(e.payload.text)},"*"),xe(i.inputState,i.inputPlaceholder),_(".iticks-footer-form-container").removeClass("hidden"),Fe()&&(u||parent.postMessage({type:"show.chatwidget"},"*"),Pe=!0),te(),K=setInterval(function(){var e=i.nodes[s++%i.nodes.length];e.sender_id=bot._id,e.msg_time=Date.now(),se.updateTrigger(i,e)},1e3*i.variationTimeout);var t=se.getLastPaymentMsg();t&&"INITIATE"==t.fields.payload.state&&Se.method("message.updateFieldVal",[h,t.id,De,Oe,"State",{state:"FAILURE",orderId:null,isBlockNext:!0},null,D,landing]),o=null},isLandingPage?0:e)},updateTrigger:function(e,t){Q&&(Q.remove(),(Q=ce({fields:t,id:"1"})).addClass("init-msgs").data({trigger:t,triggers:e}).appendTo(".iticks-message-block-container"),u||parent.postMessage({type:"notif",count:1,lastIsBot:!0,message:v(t.payload.text)},"*"),te())},removeTriggerFromUI:function(){if(se.removeTrigger(),ie){for(var e=0;e<ie.length;e++)ie[e].remove();ie=[],_(".quick-replies").empty().removeData()}Q&&(Q.remove(),Q=null,_(".quick-replies").empty().removeData())},removeTrigger:function(){C=!1,K&&(clearInterval(K),K=null),m&&(clearTimeout(m),m=null)},getLastPaymentMsg:function(){return Y},getLastWebviewMsg:function(){return V},removeUnfilledForm:function(){var e=_(".iticks-info-q-form");e.find(".skip").hide(),e.find(".submit").hide(),e.find(".tick-img").remove(),e.find(".field-item").addClass("disabled"),e.find(".form-field").addClass("filled"),e.find(".resizable-text").css({visibility:"visible",position:"static"}),e.find(".form-field-input").prop("disabled",!0)},renderTypingTemplate:function(){var e=_(".typing-container");te();for(var t=null,i=["USER_SYSTEM_TEXT","USER_TEXT","USER_FILE"],s=q.length-1;0<=s;s--){var a=q[s];if(-1==i.indexOf(a.msg.fields.msg_type)){t=a.msg;break}}t?ee(e,t.fields.sender_id):bot&&ee(e,bot._id),e.removeClass("iticks-hidden"),f&&clearTimeout(f),f=setTimeout(function(){e.addClass("iticks-hidden")},4e3)}});function ae(){return P=P||_(".agent.iticks-message-block.tmpl")}function ne(s){var e=ae().clone().removeClass("tmpl").show().data(s),t=moment(s.fields.msg_time).calendar(null,{sameElse:"DD/MM/YYYY hh:mm:ssA"});s.fields.payload.text?_(".iticks-message-text",e).html(v(s.fields.payload.text)):_(".iticks-message",e).hide(),Ne();var i=_(".iticks-info-q-form.tmpl").clone().removeClass("tmpl").show();e.find(".iticks-message-group").append(i),ee(e,s.fields.sender_id);for(var a=!1,n=0;n<s.fields.payload.fields.length;n++){var l=s.fields.payload.fields[n];if(-1!=["EMAIL","PHONE","NAME","TEXT","REGEX"].indexOf(l.validation.type)){var d="TEXT"==l.validation.type?".form-field.multiline.tmpl":".form-field.oneline.tmpl",o=_(d).clone().removeClass("tmpl").show().data(l);if(i.append(o),o.find(".field-name").text(l.name),l.value||l.is_skipped)"TEXT"==l.validation.type?(o.find(".resizable-text").text(l.value).css({visibility:"visible",position:"static"}),o.find(".form-field-input").prop("disabled",!0).val(l.value).hide()):o.find(".form-field-input").prop("disabled",!0).val(l.value),o.addClass("filled"),o.find(".skip").hide(),o.find(".submit").hide(),o.find(".tick-img").remove(),o.find(".field-item").addClass("disabled");else{if("EMAIL"==l.validation.type)o.find("input").attr("type","email");else if("PHONE"==l.validation.type){o.find("input").attr("type","tel");var r=["IN","US","GB"];l.meta&&l.meta.preferred_countries&&0<l.meta.preferred_countries.length&&(r=l.meta.preferred_countries),Re&&Re.location&&Re.location.country_code&&(-1==r.indexOf(Re.location.country_code.toUpperCase())?r.unshift(Re.location.country_code):r.sort(function(e,t){return e==Re.location.country_code?-1:t==Re.location.country_code?1:0}));var c={separateDialCode:!0,preferredCountries:r};l.meta&&l.meta.only_countries&&0<l.meta.only_countries.length&&(c.onlyCountries=l.meta.only_countries,1==c.onlyCountries.length&&(c.allowDropdown=!1));var p=intlTelInput(o.find("input").get(0),c);o.find("input").eq(0).data("intl",p)}else"REGEX"!=l.validation.type||"\\d+"!=l.validation.regex_pattern&&"\\d*"!=l.validation.regex_pattern||o.find("input").attr("type","number");if(o.addClass("unfilled"),o.find(".form-field-input").focus(),o.find(".tick-img").remove(),l.validation&&l.validation.skip&&o.find(".skip").show().off("click").on("click",function(){var e=_(this).closest(".form-field"),t=e.data(),i=e.closest(".init-msgs").length<1;e.find(".skip").text("Skipping..").addClass("disabled"),e.find(".submit").hide(),e.find(".tick-img").remove(),e.find(".field-item, .field-btns").addClass("disabled"),e.find(".resizable-text").css({visibility:"visible",position:"static"}),e.find(".form-field-input").prop("disabled",!0),Se.method("message.updateFieldVal",[h,s.id,De,Oe,t.name,{isSkip:!0},i?null:R(),D,landing],function(){var e=s.fields.payload.fields;e[e.length-1].questionId==t.questionId&&se.renderTypingTemplate()})}),a){o.hide();var m=_(".form-field.unfilled").eq(-1);if(1==m.length){m.hide();var f=m.parent();0==f.children(":visible").length&&(f.hide(),0==f.prev(":visible").length&&f.closest(".iticks-message-block").hide())}}a=!0}}}return e.find(".iticks-time").text(t),e}function le(e){var t=e.template,a=e.msg,i=_(".iticks-info-q-form",t);i.empty();for(var s=!1,n=0;n<a.fields.payload.fields.length;n++){var l=a.fields.payload.fields[n];if(-1!=["EMAIL","PHONE","NAME","TEXT","REGEX"].indexOf(l.validation.type)){var d="TEXT"==l.validation.type?".form-field.multiline.tmpl":".form-field.oneline.tmpl",o=_(d).clone().removeClass("tmpl").show().data(l);if(i.append(o),o.find(".field-name").text(l.name),l.value||l.is_skipped)"TEXT"==l.validation.type?(o.find(".resizable-text").text(l.value).css({visibility:"visible",position:"static"}),o.find(".form-field-input").prop("disabled",!0).val(l.value).hide()):o.find(".form-field-input").prop("disabled",!0).val(l.value),o.addClass("filled"),o.find(".skip").hide(),o.find(".submit").hide(),o.find(".tick-img").remove(),o.find(".field-item").addClass("disabled");else{if("EMAIL"==l.validation.type)o.find("input").attr("type","email");else if("PHONE"==l.validation.type){o.find("input").attr("type","tel");var r=["IN","US","GB"];l.meta&&l.meta.preferred_countries&&0<l.meta.preferred_countries.length&&(r=l.meta.preferred_countries),Re&&Re.location&&Re.location.country_code&&(r.indexOf(Re.location.country_code.toUpperCase())<0?r.unshift(Re.location.country_code):r.sort(function(e,t){return e==Re.location.country_code?-1:t==Re.location.country_code?1:0}));var c={separateDialCode:!0,preferredCountries:r};l.meta&&l.meta.only_countries&&0<l.meta.only_countries.length&&(c.onlyCountries=l.meta.only_countries,1==c.onlyCountries.length&&(c.allowDropdown=!1));var p=intlTelInput(o.find("input").get(0),c);o.find("input").eq(0).data("intl",p)}else"REGEX"!=l.validation.type||"\\d+"!=l.validation.regex_pattern&&"\\d*"!=l.validation.regex_pattern||o.find("input").attr("type","number");o.addClass("unfilled"),o.find(".tick-img").remove(),l.validation&&l.validation.skip&&o.find(".skip").show().off("click").on("click",function(){var e=_(this).closest(".form-field"),s=e.data(),t=e.closest(".init-msgs").length<1;e.find(".skip").text("Skipping..").addClass("disabled"),e.find(".submit").hide(),e.find(".tick-img").remove(),e.find(".field-item, .field-btns").addClass("disabled"),e.find(".resizable-text").css({visibility:"visible",position:"static"}),e.find(".form-field-input").prop("disabled",!0),Se.method("message.updateFieldVal",[h,a.id,De,Oe,s.name,{isSkip:!0},t?null:R(),D,landing],function(e,t){var i=a.fields.payload.fields;i[i.length-1].questionId==s.questionId&&se.renderTypingTemplate()})}),s?o.hide():o.find(".form-field-input").focus(),s=!0}}}}function de(e,t){t.fields.payload.isCaptured&&_(".iticks-multi-selection",e).empty().hide()}function oe(e,t,i){Y=t,_(".iticks-message-payment",e).empty();var s='<div class="field-name form-field-txt">'+t.fields.payload.text+'</div><div style="display: flex;flex-direction: column;justify-content: center;">';"INITIATE"==t.fields.payload.state?(s+='<div class="pay-status it-processing-button"><p>Payment Processing</p><img style="width:28px" src="'+cdnPrefix+'/client/loader.gif"/></div><div class="it-button cancel">Cancel</div></div>',_(s).appendTo(_(".iticks-message-payment",e)),_(".it-button.cancel",e).click(function(){A("FAILURE",{msgId:i,orderId:null})}),"ENABLED"==lastState?(xe("HIDDEN",null,!0),lastState="ENABLED"):xe("HIDDEN",null,!0)):"SUCCESS"==t.fields.payload.state?(s+='<div class="pay-status it-success-button"><p>Payment Success</p><img class="it-state" src="'+cdnPrefix+'/client/success.svg"/></div></div>',_(s).appendTo(_(".iticks-message-payment",e)),Ne()):"FAILURE"==t.fields.payload.state?(_(s+='<div class="pay-status it-failure-button"><p>Payment Failed</p></div></div>').appendTo(_(".iticks-message-payment",e)),parent.postMessage({type:"hide.paymentForm",msgId:i},"*"),Ne()):(s+='<div class="it-button submit pay-now">'+(t.fields.payload.payBtnText||"Pay Now")+"</div></div>",_(s).appendTo(_(".iticks-message-payment",e)),_(".pay-now",e).click(function(){parent.postMessage({type:"show.paymentForm",msgId:t.id},"*")}),"ENABLED"==lastState?(xe("HIDDEN",null,!0),lastState="ENABLED"):xe("HIDDEN",null,!0))}function re(e,i){if(i.fields.payload.rating&&e){var s=e.find(".iticks-message").eq(-1),t=["Hate","Dislike","Neutral","Like","Love"],a=t[i.fields.payload.rating-1],n=_(".ratings",s);if(n&&0<n.length)return _("img",n).off("click"),_("img",n).removeClass("selected-rating iticks-pointer"),void _('img[rating*="'+i.fields.payload.rating.toString()+'"]',n).addClass("selected-rating");var l=_('<div class="iticks-ratings"><div class="ratings"></div></div>');if(_(".iticks-message-rating",s).empty().removeData(),_(l).appendTo(_(".iticks-message-rating",s)),t.forEach(function(e,t){a?a==e?(e=_('<img class="selected-rating" src="assets/rating/'+e.toLowerCase()+'.svg" rating="'+(t+1)+'" />')).appendTo(_(".ratings",s)):(e=_('<img src="assets/rating/'+e.toLowerCase()+'.svg" rating="'+(t+1)+'" />')).appendTo(_(".ratings",s)):((e=_('<img class="iticks-pointer" src="assets/rating/'+e.toLowerCase()+'.svg" rating="'+(t+1)+'" />')).appendTo(_(".ratings",s)),e.click(function(){var e=parseInt(_(this).attr("rating")),t=_(".ratings",s);t&&0<t.length&&(_("img",t).off("click"),_("img",t).removeClass("selected-rating iticks-pointer"),_(this).addClass("selected-rating")),Se.method("message.updateFieldVal",[h,i.id,De,Oe,"Rating",{rating:e,text:null},null,D,landing])}))}),i.fields.payload.comment){var d=_('<span class="iticks-ratings-label">Comment</span><div class="rating-comment"><span>'+i.fields.payload.comment+"</span></div>");_(d).appendTo(_(".iticks-ratings",s))}var o=_(".user-rating").data().msg;return o&&o.id==i.id?(_(".user-rating").addClass("hidden").empty().removeData(),Ne()):o||Ne(),e}return H(i),null}function ce(e){var t=_(".iticks-chat-send-button"),i=ae().clone().removeClass("tmpl").show(),s=moment(e.fields.msg_time).calendar(null,{sameElse:"DD/MM/YYYY hh:mm:ssA"});e.fields.payload.text?(_(".iticks-message-text",i).html(v(e.fields.payload.text)),i.appendTo(".iticks-message-block-container"),i.find(".iticks-time").text(s)):_(".iticks-message",i).hide(),ee(i,e.fields.sender_id);var a=_(".quick-replies").empty().removeClass("hidden");if("DROPDOWN"!=e.fields.payload.option_display_mode)for(var n=0;n<e.fields.payload.options.length;n++){var l="qrnode";e.fields.payload.options[n].css_class&&(l+=" "+e.fields.payload.options[n].css_class),_("<div/>").addClass(l).text(e.fields.payload.options[n].text).data(e.fields.payload.options[n]).appendTo(a)}if(Ne(),"DROPDOWN"==e.fields.payload.option_display_mode){"HIDDEN"==lastState?(xe("ENABLED",null,!0),lastState="HIDDEN"):xe("ENABLED",null,!0),be(!1),_(".txtBox").addClass("txtBoxHidden"),_(".quick-drpdown").empty().removeClass("txtBoxHidden"),_("<select/>").addClass("drpdown").appendTo(".quick-drpdown");var d=[];for(n=0;n<e.fields.payload.options.length;n++)d.push({value:e.fields.payload.options[n].text,name:e.fields.payload.options[n].text});_(".drpdown").selectize({options:d,labelField:"name",searchField:["name"],maxOptions:5e3,maxItems:1,placeholder:e.fields.payload.placeholder||"Type to search...",onInitialize:function(){_(".selectize-dropdown").before('<div class="no-result-dd">Please choose an option from the given list.</div>')},onChange:function(e){""!=(we=e)?(t.addClass("active").focus(),_(".iticks-send-submit-text").addClass("show")):(t.removeClass("active"),_(".iticks-send-submit-text").removeClass("show"))},onType:function(e){_(".selectize-dropdown").is(":visible")?(_(".no-result-dd").hide(),_(".quick-drpdown").css("padding-top",0)):(_(".no-result-dd").show(),_(".quick-drpdown").css("padding-top",10))},onBlur:function(){_(".no-result-dd").hide(),_(".quick-drpdown").css("padding-top",0)}})}return a.data({msg:e}),"VERTICAL"==e.fields.payload.option_display_mode?a.addClass("vertical"):a.removeClass("vertical"),i}function pe(i){var e=ae().clone().removeClass("tmpl").show(),t=moment(i.fields.msg_time).calendar(null,{sameElse:"DD/MM/YYYY hh:mm:ssA"});if(i.fields.payload.text?(_(".iticks-message-text",e).html(v(i.fields.payload.text)),e.appendTo(".iticks-message-block-container"),e.find(".iticks-time").text(t)):_(".iticks-message",e).hide(),i.fields.payload.isCaptured)return ee(e,i.fields.sender_id),e;var s=_(".iticks-multi-selection").clone().show();e.find(".iticks-message-group").append(s),ee(e,i.fields.sender_id);var a=_(".multi-quick-replies",s).empty().removeClass("hidden");if(i.fields.payload.options)for(var n=0;n<i.fields.payload.options.length;n++){var l="msnode";i.fields.payload.options[n].css_class&&(l+=" "+i.fields.payload.options[n].css_class);var d='<input type="checkbox" id="'+i.fields.payload.options[n].text+'"><label class="'+l+'" for="'+i.fields.payload.options[n].text+'">'+i.fields.payload.options[n].text+"</label>";_(d).appendTo(a)}return Ne(),a.data({msg:i}),i.fields.payload.skip&&s.find(".skip").show().off("click").on("click",function(){_(s).addClass("hidden"),J(null,"MultiSelectionValues",{isSkipped:!0},"USER_ACTION"),Se.method("message.updateFieldVal",[h,i.id,De,Oe,"MultiSelection",!0,null,D,landing])}),_(".submit",s).off("click").click(function(){var e=[];if(_("input:checked",s).each(function(){e.push(_(this).prop("id"))}),0<e.length){_(s).addClass("hidden");var t=e.join(",");J(t,"MultiSelectionValues"),Se.method("message.updateFieldVal",[h,i.id,De,Oe,"MultiSelection",!0,null,D,landing])}}),e}function me(e){var i=ae().clone().removeClass("tmpl").show(),t=moment(e.fields.msg_time).calendar(null,{sameElse:"DD/MM/YYYY hh:mm:ssA"});if(ee(i,e.fields.sender_id),e.fields.payload.text&&!e.fields.payload.options?_(".iticks-message-text",i).html(v(e.fields.payload.text,!e.fields.isBotMsg)):e.fields.payload.options&&_(".iticks-message-text",i).remove(),e.fields.payload.text&&e.fields.payload.img?_('<div style="display: block;margin-top: 8px;"><img src="'+e.fields.payload.img+'" style="max-width: 100%;"></div>').appendTo(_(".iticks-message-text",i)):e.fields.payload.img&&(_(".iticks-message-text",i).remove(),_('<div class="iticks-message-text"><img src="'+e.fields.payload.img+'" style="max-width: 100%;"></div>').appendTo(_(".iticks-message",i))),e.fields.payload.links&&!e.fields.payload.img&&(_(".iticks-message",i).css("display","block"),_(".iticks-message-links",i).addClass("links-block"),e.fields.payload.links.forEach(function(t){"PLAYBOOK"==t.link_type?_('<a style="display:flex;" class="iticks-message-link"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").click(function(){var e={data:t.url,type:"event"};Se.method("user-functions.call",[e,De,Oe,h,x])}).appendTo(_(".iticks-message-links",i)):l&&t.mobile_url?t.open_in_new_tab?_('<a style="display:flex;" class="iticks-message-link" href="'+t.mobile_url+'" target="_blank"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").appendTo(_(".iticks-message-links",i)):_('<a style="display:flex;" class="iticks-message-link" href="'+t.mobile_url+'" target="_parent"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").appendTo(_(".iticks-message-links",i)):!l&&t.web_url?t.open_in_new_tab?_('<a style="display:flex;" class="iticks-message-link" href="'+t.web_url+'" target="_blank"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").appendTo(_(".iticks-message-links",i)):_('<a style="display:flex;" class="iticks-message-link" href="'+t.web_url+'" target="_parent"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").appendTo(_(".iticks-message-links",i)):t.link_type&&(t.open_in_new_tab?_('<a style="display:flex;" class="iticks-message-link" href="'+t.url+'" target="_blank"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").appendTo(_(".iticks-message-links",i)):_('<a style="display:flex;" class="iticks-message-link" href="'+t.url+'" target="_parent"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").appendTo(_(".iticks-message-links",i)))})),"AGENT_YOUTUBE"==e.fields.payload._type&&e.fields.payload.url){var s=E(e.fields.payload.url);e.fields.payload.autoplay&&(s+="?autoplay=1"),e.fields.payload.text?(_(".iticks-message-text",i).css("width","100%"),_('<div style="display: block;margin-top: 8px;"><iframe width="100%" style="height:40vw" src="'+s+'" frameborder="0" allow="autoplay;"  allowfullscreen></iframe></div>').appendTo(_(".iticks-message-text",i))):(_(".iticks-message-text",i).remove(),_('<div class="iticks-message-text" style="width:100%"><iframe width="100%" style="height:40vw" src="'+s+'" frameborder="0" allow="autoplay;"  allowfullscreen></iframe></div>').appendTo(_(".iticks-message",i)))}if(Ne(),"AGENT_RATING"==e.fields.payload._type){var a=re(i,e);a&&(i=a)}return"USER_PAYMENT"==e.fields.payload._type&&e.fields.payload.options&&(_(".iticks-message-payment.tmpl",i).removeClass("tmpl").show(),_(".iticks-message",i).css("display","block"),oe(i,e,e.id)),i&&i.find(".iticks-time").text(t),i}function fe(t){V=t,"HIDDEN"==lastState?(xe("ENABLED",null,!0),lastState="HIDDEN"):xe("ENABLED",null,!0),be(!1),_(".txtBox").addClass("txtBoxHidden"),_(".quick-drpdown").addClass("txtBoxHidden"),_(".iticks-chat-send-button").addClass("hidden"),_(".webview-selector").removeClass("txtBoxHidden"),_("#webview-selector").text(t.fields.payload.actionBtnText||"OPEN WEBVIEW"),_("#webview-selector").click(function(){var e=_(".iticks-webview-block");switch(e.removeClass("hidden"),_(".iframe-loading").removeClass("hidden"),_(".iticks-webview",e).removeClass("hidden"),t.fields.payload.webViewMode){case"COMPACT":_(".iticks-webview",e).css("height","50%");break;case"TALL":_(".iticks-webview",e).css("height","75%");break;case"FULL":_(".iticks-webview",e).css("height","100%");break;default:_(".iticks-webview",e).css("height","75%")}_(".iticks-webview-title",e).text(t.fields.payload.title),_(".iticks-webview-cancel",e).click(function(){_(".iframe-loading").addClass("hidden"),_(".iticks-webview",e).css("height","0%"),setTimeout(function(){e.addClass("hidden")},400)}),_("#webviewiframe").attr("src",t.fields.payload.template)})}function ge(e){var s=_(".iticks-chat-send-button");"HIDDEN"==lastState?(xe("ENABLED",null,!0),lastState="HIDDEN"):xe("ENABLED",null,!0),be(!1);var t={autoClose:!0,dateFormat:"dd-M-yyyy",onSelect:function(e,t,i){e?(_(".iticks-send-submit-text").addClass("show"),s.addClass("active").focus(),s.removeClass("disable-button")):(s.removeClass("active"),_(".iticks-send-submit-text").removeClass("show"),s.addClass("disable-button"))},onShow:function(e){e.selectedDates.length<1&&_(".iticks-chat-send-button").addClass("disable-button")}};e.fields.payload.allow_old_dates?(t.minDate="",_("#datepickerMob").attr("min","")):(t.minDate=new Date,_("#datepickerMob").attr("min",moment().format("YYYY-MM-DD"))),_("#datepickerMob").val(""),_("#datepicker").datepicker().data("datepicker").clear(),_("#datepicker").datepicker(t);var i=ae().clone().removeClass("tmpl").show(),a=moment(e.fields.msg_time).calendar(null,{sameElse:"DD/MM/YYYY hh:mm:ssA"});if(ee(i,e.fields.sender_id),_(".iticks-message-text",i).html(v(e.fields.payload.text,!e.fields.isBotMsg)),i.find(".iticks-time").text(a),_(".txtBox").addClass("txtBoxHidden"),_(".quick-drpdown").addClass("txtBoxHidden"),!l||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i))_(".date-picker-Mob").addClass("txtBoxHidden"),_(".date-picker").removeClass("txtBoxHidden");else{_(".date-picker").addClass("txtBoxHidden"),_(".date-picker-Mob").removeClass("txtBoxHidden");var n="change";(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i))&&(n="blur"),_("#datepickerMob").off(n).on(n,function(){var e=_("#datepickerMob").val();e&&(J(moment(e).format("DD-MMM-YYYY"),"Datepicker"),Ne()),_(".iticks-chat-send-button").removeClass("active")})}return i}function ue(i){"ENABLED"==lastState?(xe("HIDDEN",null,!0),lastState="ENABLED"):xe("HIDDEN",null,!0);var s={min:0,max:0},e={orientation:"horizontal",range:!1,min:i.fields.payload.min,max:i.fields.payload.max,value:i.fields.payload.defaultMin,animate:!0,step:i.fields.payload.step||1,slide:function(e,t){_(t.handle).text(t.value),_(".slider-picked-values").text(t.value+" "+i.fields.payload.unit),s.min=s.max=t.value,t.values&&0<t.values.length&&(_(".slider-picked-values").text(t.values[0]+" - "+t.values[1]+" "+i.fields.payload.unit),s.min=t.values[0],s.max=t.values[1])},create:function(){s.min=s.max=i.fields.payload.defaultMin,_(".slider-picked-values").text(i.fields.payload.defaultMin+" "+i.fields.payload.unit),_(".ui-slider-handle").first().text(i.fields.payload.defaultMin),"RANGE"==i.fields.payload.sliderType&&(_(".ui-slider-handle").last().text(i.fields.payload.defaultMax),_(".slider-picked-values").text(i.fields.payload.defaultMin+" - "+i.fields.payload.defaultMax+" "+i.fields.payload.unit),s.min=i.fields.payload.defaultMin,s.max=i.fields.payload.defaultMax)},start:function(){_(".slider-send-button").addClass("active")}};"RANGE"==i.fields.payload.sliderType&&(e.range=!0,e.values=[i.fields.payload.defaultMin||0,i.fields.payload.defaultMax||300],delete e.value),_(".iticks-slider").removeClass("hidden"),_("#slider").slider(e),_(".slider-values .min").text(i.fields.payload.min+" "+i.fields.payload.unit),_(".slider-values .max").text(i.fields.payload.max+" "+i.fields.payload.unit),_(".slider-title").text(i.fields.payload.title),_(".slider-send-button").off("click").click(function(){var e=_(".slider-picked-values").text();J(e,"SliderValue",s),Ne(),_("#slider").slider("destroy")})}function ye(e){var t=(B=B||_(".user.iticks-message-block.tmpl")).clone().removeClass("tmpl").show(),i="";if(i="SENDING"==e.fields.view_state?"Sending...":moment(e.fields.msg_time).calendar(null,{sameElse:"DD/MM/YYYY hh:mm:ssA"}),"USER_FILE"==e.fields.msg_type){var s='<svg class="it-upload-icon" focusable="false" aria-hidden="true" viewBox="0 0 16 18"><path d="M14.154 6.918l-.004.003.001-.004-3.287 3.286-.006-.005-3.574 3.574c-.016.017-.03.036-.048.053l-.05.047-.043.041v-.002c-1.167 1.07-2.692 1.331-3.823.2-1.13-1.13-.89-2.677.18-3.843l-.005-.004.074-.073.016-.018c.006-.005.012-.009.017-.016l6.053-6.053.761.76-6.053 6.054-.029.028v.001l-.005.004-.073.074c.011-.01.025-.018.035-.03-.688.75-.93 1.636-.21 2.356.72.72 1.583.456 2.333-.232l-.03.034.04-.042.01-.008.008-.009.033-.03.031-.034.01-.009.007-.009 5.004-5.003.005.006 1.858-1.859c1.223-1.218 1.51-2.913.291-4.132C12.462.806 10.414.74 9.195 1.958L2.248 8.905c.003 0 .006-.002.008-.004-1.625 1.667-1.542 4.43.103 6.074 1.646 1.646 4.474 1.795 6.141.17-.003.002-.004.008-.008.012l.047-.047 6.053-6.054.042-.042.743.78-.025.021.001.002-6.05 6.05-.002.002-.002.001-.046.046h-.002c-2.094 2.04-5.578 1.894-7.652-.18-2.049-2.049-2.15-5.407-.183-7.505l-.006-.005h-.002l.076-.078 6.943-6.944.003-.002.004-.005c1.641-1.64 4.367-1.574 6.008.066 1.64 1.642 1.353 4.014-.288 5.655z" fill-rule="evenodd"></path></svg>'+v(e.fields.payload.name,!0);"UPLOADING"==e.fields.payload.status?s+=" Uploading...":"FAILED"==e.fields.payload.status&&(s+=" Not Uploaded."),_(".iticks-message-text",t).html(s).data("msg",e)}else if("USER_ACTION"==e.fields.msg_type)if(e.fields.payload&&e.fields.payload.skip){_(".iticks-message-text",t).html(v("SKIP",!0)).data("msg",e)}else _(".iticks-message-text",t).html(v(e.fields.payload.text,!0)).data("",e);else _(".iticks-message-text",t).html(v(e.fields.payload.text,!0)).data("msg",e);return t.find(".iticks-time").text(i),Ne(),t}function ve(e,t){var i=moment(e.fields.msg_time).calendar(null,{sameElse:"DD/MM/YYYY hh:mm:ssA"}),s=ae().find(".iticks-message").clone();if(!e.fields.payload.text&&!e.fields.payload.img||e.fields.payload.options?_(".iticks-message-text",s).remove():_(".iticks-message-text",s).html(v(e.fields.payload.text,!e.fields.isBotMsg)),t.find(".iticks-message-group").append(s),e.fields.payload.img&&_('<div style="display: block;margin-top: 8px;"><img src="'+e.fields.payload.img+'" style="max-width: 100%;"></div>').appendTo(_(".iticks-message-text",s)),e.fields.payload.links&&!e.fields.payload.img&&(_(".iticks-message",s).css("display","block"),_(".iticks-message-links",s).addClass("links-block"),e.fields.payload.links.forEach(function(t){"PLAYBOOK"==t.link_type?_('<a style="display:flex;" class="iticks-message-link"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").click(function(){var e={data:t.url,type:"event"};Se.method("user-functions.call",[e,De,Oe,h,x])}).appendTo(_(".iticks-message-links",s)):l&&t.mobile_url?t.open_in_new_tab?_('<a style="display:flex;" class="iticks-message-link" href="'+t.mobile_url+'" target="_blank"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").appendTo(_(".iticks-message-links",s)):_('<a style="display:flex;" class="iticks-message-link" href="'+t.mobile_url+'" target="_parent"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").appendTo(_(".iticks-message-links",s)):!l&&t.web_url?t.open_in_new_tab?_('<a style="display:flex;" class="iticks-message-link" href="'+t.web_url+'" target="_blank"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").appendTo(_(".iticks-message-links",s)):_('<a style="display:flex;" class="iticks-message-link" href="'+t.web_url+'" target="_parent"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").appendTo(_(".iticks-message-links",s)):t.link_type&&(t.open_in_new_tab?_('<a style="display:flex;" class="iticks-message-link" href="'+t.url+'" target="_blank"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").appendTo(_(".iticks-message-links",s)):_('<a style="display:flex;" class="iticks-message-link" href="'+t.url+'" target="_parent"><img src="'+t.icon+'" style="width:20px;height:20px;flex: 0 0 20px;"/><span>'+t.title+"</span></a>").appendTo(_(".iticks-message-links",s)))})),"AGENT_YOUTUBE"==e.fields.payload._type&&e.fields.payload.url){var a=E(e.fields.payload.url);e.fields.payload.autoplay&&(a+="?autoplay=1"),e.fields.payload.text?(_(".iticks-message-text",s).css("width","100%"),_('<div style="display: block;margin-top: 8px;"><iframe width="100%" style="height:40vw" src="'+a+'" frameborder="0" allow="autoplay;" allowfullscreen></iframe></div>').appendTo(_(".iticks-message-text",s))):(_(".iticks-message-text",s).remove(),_('<div class="iticks-message-text" style="width:100%"><iframe width="100%" style="height:40vw" src="'+a+'" frameborder="0" allow="autoplay;" allowfullscreen></iframe></div>').appendTo(s))}return Ne(),"USER_PAYMENT"==e.fields.payload._type&&e.fields.payload.options?(_(".iticks-message-payment.tmpl",s).removeClass("tmpl").show(),_(".iticks-message",s).css("display","block"),oe(s,e,e.id)):"AGENT_RATING"==e.fields.msg_type&&re(s,e),t&&t.find(".iticks-time").text(i),s}function _e(e){var t=(F=F||_(".system.iticks-message-block.tmpl")).clone().removeClass("tmpl").show(),i=Ue[e.fields.sender_id];return i&&"takeover"==e.fields.payload.text?(i.name&&_(".iticks-message-text",t).html("You are now chatting with "+i.name),t):null}I.onChange(function(e,t){"WIDGET_MAXIMIZED"==I.getValue()?(_(".iticks-chat-input").focus(),se.resetUnread()):null!=t&&se.resetUnread()});var he=[],ke=null;function Ee(){if(!(he.length<1)){for(var e=-1,t=r("lstmsgtime")||0,i=he.length-1;-1<i;i--)if(!he[i].fields.isBotMsg||"READ"==he[i].fields.view_state||he[i].fields.msg_time<t){e=i;break}if(-1!=e){for(;-1<e;){var s=he.shift();se.addMessage(s),e--}return ke&&(clearTimeout(ke),ke=null),_(".typing-container").addClass("iticks-hidden"),void Ee()}if(!ke){var a=_(".typing-container");-1<["USER_SYSTEM_TEXT","CLIENT_JAVASCRIPT"].indexOf(he[0].fields.msg_type)||a.removeClass("iticks-hidden"),te(),ee(a,he[0].fields.sender_id),ke=setTimeout(function(){var e=he.shift();se.addMessage(e),ke=null,_(".typing-container").addClass("iticks-hidden"),setTimeout(Ee,400)},1200)}}}function Te(){for(ke&&(clearTimeout(ke),ke=null);0<he.length;){var e=he.shift();se.addMessage(e)}_(".typing-container").addClass("iticks-hidden")}function xe(e,t,i){t=t||"Type a message...",isLastInputForced=!!i,"ENABLED"==e?(_(".iticks-chat-input").prop("disabled",!1).attr("placeholder",t),_(".iticks-footer-form-container").css("display","").removeClass("disabled")):"DISABLED"==e?(_(".iticks-chat-input").prop("disabled",!0).attr("placeholder",t),_(".iticks-footer-form-container").css("display","").addClass("disabled")):"HIDDEN"==e&&_(".iticks-footer-form-container").hide(),lastState=e}function be(e){M&&M.fields&&!M.fields.isWithBot&&e&&company&&company.company_settings&&company.company_settings.enable_attachment_service?(_(".upload-box").removeClass("hidden"),_(".iticks-chat-send-button").addClass("hidden")):(_(".iticks-chat-send-button").removeClass("hidden"),_(".upload-box").addClass("hidden"))}function Ie(e,t){if("added"==t){if(-1==["USER_TEXT","USER_ACTION","AGENT_TEXT","AGENT_TRIGGER_QUESTION","AGENT_MULTI_SELECTION","AGENT_FORM","AGENT_QUESTION_FORM","AGENT_RECO","USER_SYSTEM_TEXT","SYSTEM_TEXT","AGENT_FORM_DATEPICKER","AGENT_SLIDER","USER_PAYMENT","AGENT_RATING","AGENT_WEBVIEW","CLIENT_JAVASCRIPT","AGENT_YOUTUBE","USER_FILE"].indexOf(e.fields.msg_type))return void console.log("invalid msg_type for ",e);if(!e.fields.payload||e.fields.msg_type!=e.fields.payload._type)return void console.log("corrupted msg ",e);he.push(e),he.sort(function(e,t){return e.fields.msg_time<t.fields.msg_time?-1:e.fields.msg_time>t.fields.msg_time?1:0}),Ee()}else"changed"==t&&se.updateMessage(e)}lastState=null,isLastInputForced=!1;var we="",Ce="",Ne=function(){_(".quick-drpdown").empty(),_(".quick-drpdown").addClass("txtBoxHidden"),_(".date-picker").addClass("txtBoxHidden"),_(".date-picker-Mob").addClass("txtBoxHidden"),_(".webview-selector").addClass("txtBoxHidden"),_(".iticks-slider").addClass("hidden"),_(".txtBox").removeClass("txtBoxHidden"),_(".upload-box").removeClass("hidden"),_(".iticks-chat-send-button").addClass("hidden"),_(".iticks-send-submit-text").removeClass("show"),be(!0),function e(){-1<["HIDDEN","ENABLED"].indexOf(lastState)&&xe(lastState)}()};function Ae(t){g(),function s(){S&&clearInterval(S);var e=null;S=setInterval(function(){"Hide"==e&&"Hide"==b||(p.push({type:b,time:Date.now(),chatuser:Oe,company:h,device:De,tab_id:T,url:x}),e=b),g()},company.company_settings.event_interval||6e3),g()}(),u||parent.postMessage({type:"frame.ready"},"*");var n=_(".iticks-chat-send-button"),l=_(".iticks-chat-input");_(".quick-drpdown");if(_(".attach-btn").click(function(){_("input#attachment-file").trigger("click")}),_("input#attachment-file").change(function(){var i=_("input#attachment-file").get()[0].files[0];if(i)if(10<i.size/1024/1024)alert("The file size can not exceed 10MB.");else{function s(){Se.method("message.uploadComplete",[n,l])}var n=null,l="IN_PROGRESS";Se.method("session.getSignedUploadPath",[Oe,h,i.name],function(e,t){var a={path:t.params.Key,_type:"USER_FILE",name:t.filename,status:"UPLOADING",node_id:Date.now()+""};_.ajax({url:t.url,type:"PUT",contentType:t.contentType,headers:{"Content-Disposition":t.params.ContentDisposition},xhr:function(){var e=_.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=e.total,i=e.loaded,s=Math.floor(100*i/t).toString();a.progress=s,Se.method("message.sendFile.progress",[h,De,D,Oe,a,landing])}},!1),e},processData:!1,data:i,success:function(){l="SUCCESS",s()},error:function(){l="FAILED",s()}}),_("input#attachment-file").val(""),Ie({collection:"messages",msg:"added",id:a.node_id,fields:{isBotMsg:!1,msg_time:Date.now(),msg_type:a._type,sender_id:"4TacrSuTKNvu4Fphd_cu",view_state:"SENDING",payload:a}},"added"),Se.method("message.sendFile",[h,De,D,Oe,a,landing],function(e,t){(n=t)&&s()})})}}),n.off("click").click(function(){if(Me){if(_(".quick-drpdown").hasClass("txtBoxHidden"))if(_(".date-picker").hasClass("txtBoxHidden"))if(_(".date-picker-Mob").hasClass("txtBoxHidden"))if(_(".user-rating").hasClass("hidden")){s=l.val();l.val(""),J(s)}else{var e=_(".user-rating").data().msg,t=_(".iticks-message-rating").closest(".init-msgs").length<1,i=_(".user-rating .selected-rating").index()+1,s=l.val();l.val(""),Se.method("message.updateFieldVal",[h,e.id,De,Oe,"Rating",{rating:i,comment:s},t?null:R(),D,landing]),Ne(),_(".user-rating ").empty().removeData()}else(Ce=_("#datepickerMob").val())&&(J(moment(Ce).format("DD-MMM-YYYY"),"Datepicker"),Ne());else(Ce=_("#datepicker").val())&&(J(Ce,"Datepicker"),Ne(),_("#datepicker").val(null));else we&&(J(we,"DropdownValue"),Ne(),we="",_(".iticks-send-submit-text").removeClass("show"));n.removeClass("active")}}),l.off("keyup").keyup(function(){var e=l.val(),t=parseInt(_(".user-rating .selected-rating").attr("rating")||"0");0<e.length||t?(be(!1),n.addClass("active")):(n.removeClass("active"),be(!0))}),l.off("keypress").keypress(function(e){if("Enter"==e.key&&!e.shiftKey){if(e.preventDefault(),!Me)return;var t=_(".user-rating").data().msg,i=_(".iticks-message-rating").closest(".init-msgs").length<1,s=parseInt(_(".user-rating .selected-rating").attr("rating")||"0"),a=l.val();l.val(""),s?(Se.method("message.updateFieldVal",[h,t.id,De,Oe,"Rating",{rating:s,comment:a},i?null:R(),D,landing]),Ne(),_(".user-rating ").empty().removeData()):J(a),n.removeClass("active")}}),D||!company.company_settings.disable_agent_init_chat||Ge&&t)Ge=!0,Se.sub("messages.forclient.v2",[De,h,0],function(){if(Be&&!t){!0,Te();var e=1e3*(company.company_settings.engage_wait_time||0);"VARIATON_TRIGGERS"==Be.type?se.addTriggers(Be,e):se.addMultiMsgTrigger(Be,0,null,e)}else t||_(".iticks-footer-form-container").removeClass("hidden")});else if(t||function a(t){_(d).on("storage",function(e){e.key==h+"_iticks.subs"&&_.isFunction(t)&&t()})}(function(){Ge||Se.sub("messages.forclient.v2",[De,h,0],function(){})}),Be&&!t){!0,Te();var e=1e3*(company.company_settings.engage_wait_time||0);"VARIATON_TRIGGERS"==Be.type?se.addTriggers(Be,e):se.addMultiMsgTrigger(Be,0,null,e)}else t||_(".iticks-footer-form-container").removeClass("hidden");function i(e){var t=e.data();if(t){var i=e.closest(".iticks-message-block").data(),s=_.trim(e.find(".form-field-input").val());if(!s)return e.find(".error-msg").text(t.validation.failMsg||"Please enter a valid value").show().fadeOut(2e3),void(0<(a=_(".unfilled input")).length&&a.eq(0).focus());var a,n=e.closest(".init-msgs").length<1,l=k(t.validation,s,e.find(".form-field-input"));if(!1===l)return e.find(".error-msg").text(t.validation.failMsg).show().fadeOut(2e3),void(0<(a=_(".unfilled input")).length&&a.eq(0).focus());e.find(".skip").hide(),e.find(".submit").text("Submitting..").addClass("disabled"),e.find(".tick-img").remove(),e.find(".field-item, .field-btns").addClass("disabled"),e.find(".resizable-text").css({visibility:"visible",position:"static"}),e.find(".form-field-input").prop("disabled",!0),Se.method("message.updateFieldVal",[h,i.id,De,Oe,t.name,l,n?null:R(),D,landing],function(){var e=i.fields.payload.fields;e[e.length-1].questionId==t.questionId&&se.renderTypingTemplate()})}}_(".quick-replies").off("click").on("click",".qrnode",function(){var e=_(this).data();_(".quick-replies").addClass("hidden"),J(e.text)}),_(".iticks-chat-send-button").on("keypress",function(e){13==e.which&&_(this).click()}),_(".iticks-message-block-container").off("keypress").on("keypress","input",function(e){13==e.which&&i(_(this).closest(".form-field"))}).off("click").on("click",".submit",function(){i(_(this).closest(".form-field"))})}var Se=null,Me=!1,De=isLandingPage?null:r("iticksId"),Re=null,Le=null,Oe=null,Ge=!1,Ue=r("agents")||{},Be=null,Pe=!1;function Fe(){if(Pe)return!1;if(function i(e){var t=r("popup_close_time");return"number"==typeof t&&Date.now()-t<e}(1e3*company.company_settings.disengage_wait))return!1;if(d.matchMedia("(max-device-width: 700px)").matches){if(!company.livechat_settings.auto_open_mobile)return!1}else if(!company.livechat_settings.auto_open_widget)return!1;return!0}function Ye(e){company.livechat_settings.enable_chat_icon_img&&e.photo&&(u||parent.postMessage({type:"set.chatIcon",chatIcon:e.photo},"*"))}function Ve(e){company.livechat_settings.agent_profile?(_(".agent-profile").removeClass("hidden"),e.photo?(_(".agent-profile .profile-image").attr("src",e.photo).show(),_(".agent-profile .profile-img-txt").hide()):(_(".agent-profile .profile-image").hide(),_(".agent-profile .profile-img-txt").css("background",a(e._id)).text(e.name.substr(0,1)).show()),_(".agent-profile .profile-name").text(e.name),e.title&&_(".agent-profile .profile-desc").text(e.title),company.logo?_(".agent-profile .comp-logo").attr("src",company.logo).show():_(".agent-profile .comp-logo").hide(),_(".agent-profile .comp-name").text(company.name)):_(".agent-profile").addClass("hidden")}function He(e){var t=_(".iticks-menu-main-content").empty();if(e.menu_data){_(".iticks-menu-title").text(e.menu_title),t.removeData().data(e),e.prev_menu_data?_(".iticks-menu-arrow").removeClass("hidden").removeData().data(e).off("click").click(function(){var e=_(this).data();e.prev_menu_data&&He({menu_title:e.prev_menu_data.menu_title,menu_data:e.prev_menu_data.menu_data,prev_menu_data:e.prev_menu_data.prev_menu_data})}):_(".iticks-menu-arrow").addClass("hidden").removeData();for(var i=0;i<e.menu_data.length;i++){var s='<div class="iticks-list"><div class="iticks-list-icon"><img src="'+e.menu_data[i].icon+'"></div><div class="iticks-list-title">'+e.menu_data[i].text+"</div>";e.menu_data[i].options&&0<e.menu_data[i].options.length&&(s+='<div class="iticks-list-arrow"><img src="https://image.flaticon.com/icons/svg/60/60758.svg"></div>');var a=_(s+="</div>");t.append(a),a.data(e.menu_data[i]).off("click").click(function(){var e=_(this).data();if(e&&e.options&&0<e.options.length){var t=e.options;He({menu_title:e.text,menu_data:t,prev_menu_data:_(".iticks-menu-main-content").data()})}else e&&e.text&&(_("#menu-arrow").removeClass("down-arrow-icon"),_(".iticks-menu-block, .iticks-menu-overlay, .iticks-menu").removeClass("active"),J(e.text,e.playbook?"MenuValue":null),_(".quick-replies").empty().removeData(),e.playbook&&Se.method("user-functions.call",[{type:"playbook",data:e.playbook},De,Oe,h,x]),Ge||(Se.sub("messages.forclient.v2",[De,h,0],function(){}),c()))})}}}function qe(){var e=company.company_settings.gdpr,t=e.consent_title||"Data Protection Bot",i=e.consent_description,s=e.opt_out_confirmation||null,a=e.opt_in_text||"Yes, I Accept",n=e.opt_out_text||"No, Not Now",l=_(".iticks-gdpr-main-content").empty(),d=_(".iticks-entry-privacy").empty(),o=_(".iticks-entry-opt").empty();if(i&&t){_(".iticks-entry-top-text").html(t),l.html(i);var r=_('<button class="opt_in it-button">'+a+"</button>"),c=_('<button class="opt_out">'+n+"</button>"),p=_('<button class="go_back">Go Back</button>');if(o.append(r),o.append(c),e.privacy_policy_link){e.privacy_policy_text||(e.privacy_policy_text=e.privacy_policy_link);var m=_('<a target="_blank" class="privacy_link" href="'+e.privacy_policy_link+'">'+e.privacy_policy_text+"</a>");d.append(m),_(".iticks-entry-privacy").show()}else _(".iticks-entry-privacy").hide();p.on("click",function(){_(".iticks-gdpr-main-content").show(),r.show(),c.show(),_(".iticks-entry-form").empty().html('<div class="entry-fields"></div>').hide(),qe()}),c.on("click",function(){s?(l.empty().html(s),o.empty().append(p)):u||parent.postMessage({type:"minimize.chat"},"*")}),r.on("click",function(){_("button",o).attr("disabled",!0),Se.method("chat-users.gdpr_opt_in",[h,Oe],function(e,t){_("button",o).attr("disabled",!1),t&&company.company_settings.entry_form&&company.company_settings.entry_form.is_entry_form_enabled?Le&&!Le.entry_form_in&&Xe():t&&(_(".iticks-entry, .iticks-entry-block").removeClass("active"),_(".iticks-entry-block").empty(),_(".iticks-chat-input").focus())})})}_(".iticks-entry-form").hide(),_(".iticks-gdpr-main-content").show(),_(".iticks-entry, .iticks-entry-block").addClass("active")}function Xe(){var e=company.company_settings.entry_form,t=e.entry_form_title||"Data Protection Bot",i=e.entry_form_description,s=e.entry_form_fields,a=_(".iticks-entry-privacy").empty(),d=_(".iticks-entry-opt").empty(),o=_('<button class="entry_form_submit it-button">Submit</button>');if(d.append(o),_(".iticks-entry-top-text").html(t),i?_(".entry-form-description").text(i):_(".entry-form-description").hide(),e.privacy_policy_link){e.privacy_policy_text||(gdpr_data.privacy_policy_text=e.privacy_policy_link);var n=_('<a target="_blank" class="privacy_link" href="'+e.privacy_policy_link+'">'+e.privacy_policy_text+"</a>");a.append(n),_(".iticks-entry-privacy").show()}else _(".iticks-entry-privacy").hide();for(var l=_(".entry-field.tmpl").clone().removeClass("tmpl").show(),r=[],c=0;c<s.length;c++){var p=s[c],m=l.clone().removeClass("tmpl").show().data(p);if(p.required?m.find(".field-name").html(p.label+'<span style="color:red;"> *</span>'):m.find(".field-name").text(p.label),m.appendTo(".entry-fields"),m.keyup(function(){if(v){var e=_(this).data(),t=_.trim(_(this).find(".form-field-input").val());!1===k({regex_pattern:e.validation,type:e.type},t,_(this).find(".form-field-input"))||!t&&e.required?_(this).find(".error-msg").text(e.error).show():_(this).find(".error-msg").text(e.error).hide()}}),r.push(m),-1!=["EMAIL","PHONE","NAME","TEXT","REGEX"].indexOf(p.type)){if("EMAIL"==p.type)m.find("input").attr("type","email");else if("PHONE"==p.type){m.find("input").attr("type","tel");var f=["IN","US","GB"];p.meta&&p.meta.preferred_countries&&0<p.meta.preferred_countries.length&&(f=p.meta.preferred_countries),Re&&Re.location&&Re.location.country_code&&(-1==f.indexOf(Re.location.country_code.toUpperCase())?f.unshift(Re.location.country_code):f.sort(function(e,t){return e==Re.location.country_code?-1:t==Re.location.country_code?1:0}));var g={separateDialCode:!0,preferredCountries:f,dropdownContainer:document.body};p.meta&&p.meta.only_countries&&0<p.meta.only_countries.length&&(g.onlyCountries=p.meta.only_countries,1==g.onlyCountries.length&&(g.allowDropdown=!1));var u=intlTelInput(m.find("input").get(0),g);m.find("input").eq(0).data("intl",u)}else"REGEX"!=p.type||"\\d+"!=p.validation&&"\\d*"!=p.validation||m.find("input").attr("type","number");m.find("input").focus()}}var y=!1,v=!1;o.on("click",function(){if(v=!0,!y){for(var e={},t=0,i=0;i<r.length;i++){var s=r[i],a=s.data(),n=_.trim(s.find(".form-field-input").val());if(n||!a.required){var l=k({regex_pattern:a.validation,type:a.type},n,s.find(".form-field-input"));!1===l?(s.find(".error-msg").text(a.error).show(),t++):e[a.save_as]=l}else s.find(".error-msg").text(a.error).show(),t++}t||(y=!0,_("button",d).attr("disabled",!0),o.css({opacity:.5}),Se.method("user-functions.call",[{type:"identify",data:e},De,Oe,h,null]),Se.method("chat-users.entry_form_in",[h,Oe],function(e,t){t&&(y=!1,o.css({opacity:""}),_(".iticks-entry, .iticks-entry-block").removeClass("active"),_(".iticks-entry-block").empty(),_(".iticks-chat-input").focus()),_("button",d).attr("disabled",!1)}))}}),_(".iticks-gdpr-main-content").hide(),_(".iticks-entry-form").show(),_(".iticks-entry, .iticks-entry-block").addClass("active")}function We(){u||parent.postMessage({type:"activity"},"*")}_(function(){d==parent?_(".iticks-top-bar-button").hide():_(".iticks-top-bar-button").click(function(){u||parent.postMessage({type:"minimize.chat"},"*"),function e(){y("popup_close_time",Date.now())}()}),Ve(bot);var e="http:"==location.protocol?"ws://":"wss://";if(Se=new liveChatDDPClient({endpoint:e+d.location.host+"/websocket",SocketConstructor:WebSocket}),!company.livechat_settings||!company.livechat_settings.widgetEnabled)return u||(parent.postMessage({type:"disable.widget"},"*"),parent.postMessage({type:"hide.chatwidget"},"*")),Se._autoreconnect=!1,void Se._socket.close();if(u||parent.postMessage({type:"enable.widget",livechat_settings:company.livechat_settings,company:company},"*"),Ye(bot),company.company_manual_chat||_(".iticks-footer-form-container").remove(),Se.on("connected",function(){u||parent.postMessage({type:"initData"},"*"),setTimeout(function(){Se.method("session.initiate",[h,De,navigator.userAgent,ref,28,landing,engageType,engageName,i],function(e,t){e?console.log(e):t&&t[0].is_blocked||(_(".loading").hide(),_(".iticks-header-top-right").removeClass("hidden"),t[4]&&"agents"==t[4].collection&&(Ue=r("agents")||{},t[4].id=t[4].fields._id,Ue[t[4].id]=t[4].fields,y("agents",Ue)),Oe=t[0]._id,iticks_link=iticks_link+"&utm_content="+Oe,_(".iticks_link").attr("href",iticks_link),Le=t[0],De=t[1]._id,Re=t[1],t[2]&&(D=t[2]._id,be(!0)),Be=t[3],isLandingPage||y("iticksId",De),company.livechat_settings&&company.livechat_settings.widgetEnabled&&company.features&&company.features.chat?"ALL"==company.livechat_settings.chatVisibilityState?(u||parent.postMessage({type:"minimize.chat"},"*"),!0):"ON_ACTIVE_CONVERSATION"==company.livechat_settings.chatVisibilityState&&D?(u||parent.postMessage({type:"minimize.chat"},"*"),!0):(u||parent.postMessage({type:"hide.chatwidget"},"*"),!1):u||parent.postMessage({type:"hide.chatwidget"},"*"),isLandingPage?company.company_settings.gdpr&&company.company_settings.gdpr.is_gdpr_enabled&&company.company_settings.gdpr.is_landing_page_enabled?Le&&!Le.gdpr_opt_in?qe():company.company_settings.entry_form&&company.company_settings.entry_form.is_entry_form_enabled&&Le&&!Le.entry_form_in&&Xe():company.company_settings.entry_form&&company.company_settings.entry_form.is_entry_form_enabled&&company.company_settings.entry_form.is_landing_page_enabled&&Le&&!Le.entry_form_in&&Xe():company.company_settings.gdpr&&company.company_settings.gdpr.is_gdpr_enabled&&Le&&!Le.gdpr_opt_in?qe():company.company_settings.entry_form&&company.company_settings.entry_form.is_entry_form_enabled&&Le&&!Le.entry_form_in&&Xe(),company&&company.company_settings&&company.company_settings.enable_left_menu&&function i(){var e=JSON.parse(company.company_settings.left_menu_data),t={menu_title:company.company_settings.left_menu_title||"Intelliticks Menu",menu_data:e,prev_menu_data:null};He(t),_(".left-menu-icon").removeClass("hidden").click(function(){_("#menu-arrow").toggleClass("down-arrow-icon"),_(".iticks-menu-block, .iticks-menu-overlay, .iticks-menu").toggleClass("active"),_(".iticks-menu-block").hasClass("active")&&He(t)}),_(".iticks-menu-overlay").off("click").click(function(){_("#menu-arrow").removeClass("down-arrow-icon"),_(".iticks-menu-block, .iticks-menu-overlay, .iticks-menu").removeClass("active")})}(),Me=!0,Ae(),Se.on("added",function(e){"conversations"==e.collection?(D=(M=e).id,"WIDGET_MAXIMIZED"!=I.getValue()&&"ON_ACTIVE_CONVERSATION"==company.livechat_settings.chatVisibilityState&&(u||parent.postMessage({type:"minimize.chat"},"*")),!0,e.fields.isWithBot?Ve(bot):e.fields.assignee&&0<e.fields.assignee.length&&(Ue=r("agents")||{})[e.fields.assignee[0].agent_id]&&Ve(Ue[e.fields.assignee[0].agent_id]),isLastInputForced?lastState=M.fields.inputState:xe(M.fields.inputState,M.fields.inputPlaceholder)):"messages"===e.collection?Ie(e,"added"):"agents"==e.collection&&(Ue=r("agents")||{},e.fields._id=e.id,Ue[e.id]=e.fields,y("agents",Ue))}),Se.on("changed",function(e){if("messages"===e.collection)Ie(e,"changed");else if("conversations"==e.collection){for(var t in e.fields)e.fields.hasOwnProperty(t)&&(M.fields[t]=e.fields[t]);if(e.cleared&&0<e.cleared.length){var i=0;for(i=0;i<e.cleared.length;i++)delete M.fields[e.cleared[i]]}if(M.fields.isWithBot)Ve(bot);else if(M.fields.assignee&&0<M.fields.assignee.length){var s=r("agents")||{};s[M.fields.assignee[0].agent_id]&&Ve(s[M.fields.assignee[0].agent_id])}isLastInputForced?lastState=M.fields.inputState:xe(M.fields.inputState,M.fields.inputPlaceholder)}}))})},100)}),Se.on("reconnected",function(){company&&Oe&&(Me=!0,_(".offline-msg").hide(),Se.method("session.reconnected",[h,De,navigator.userAgent,ref,28,"Hide"==b],function(){Ae(!0)}),"Show"==b&&p.push({type:b,time:Date.now(),chatuser:Oe,company:h,device:De,tab_id:T,url:x}),g())}),Se.on("disconnected",function(){clearInterval(S),Me=!1}),Se.on("socket_close",function(){Me=Me=!1,_(".offline-msg").show(),clearInterval(S),S=null}),_(".iticks-chat-input").focusin(function(){_(d).one("resize",function(){var e=_(".iticks-message-block").not(".tmpl").last().get(0);e&&e.scrollIntoView(!0)}),se.resetUnread()}),company.livechat_settings.enable_chat_widget_right_header&&company.livechat_settings.chat_widget_right_header_playbook){var t=company.livechat_settings.chat_widget_right_header_playbook;_(".iticks-header-top-right").click(function(){_(".init-msgs").remove(),_(".quick-replies").empty().removeData(),Se.method("user-functions.call",[{type:"playbook",data:t},De,Oe,h,x]),Ge||(Se.sub("messages.forclient.v2",[De,h,0],function(){}),c())})}_(".iticks-message-block-container").on("focus",".form-field-input",function(){var e=this;_(d).one("resize",function(){e.scrollIntoView(!0)})})}),_(document).on("keyup.resizeText keydown.resizeText","textarea.resizeText",function(){var e=_(this),t=e.prev(".resizable-text"),i=parseInt(e.attr("data-base-height"))||40;setTimeout(function(){t.text(e.val()),e.is(".iticks-chat-input")?e.css({"flex-basis":Math.max(i,t.height())+"px"}):e.height(Math.max(i,t.height()))},0)}),d.addEventListener("mousemove",We,!1),d.addEventListener("mousedown",We,!1),d.addEventListener("keypress",We,!1),d.addEventListener("DOMMouseScroll",We,!1),d.addEventListener("mousewheel",We,!1),d.addEventListener("touchmove",We,!1),d.addEventListener("MSPointerMove",We,!1),d.addEventListener("MSPointerMove",We,!1)}(window,jQuery,liveChatDDPClient,clientId);
